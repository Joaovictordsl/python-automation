#!/bin/bash

# Verifica se o usu√°rio passou a quantidade, sen√£o assume 1
QTD=${1:-1}

echo "ü§ñ Iniciando processamento de $QTD perfis..."

# 1. Captura os IDs em uma vari√°vel e converte para lista
ids_list=$(python3 user_ids.py | head -n "$QTD")

# 2. Captura os emails e senhas (mantendo sua l√≥gica de tail -r e awk)
contas_list=$(tail -n "$QTD" contas_outlook.txt | tail -r | awk -F' \\| ' '{gsub(/Email: /,"",$1); gsub(/Senha: /,"",$2); print $1"|"$2}')

# Converte as listas em arrays compat√≠veis com ZSH e BASH
# Usamos o 'tr' para garantir que a quebra de linha seja tratada corretamente
ids=($(echo "$ids_list" | tr '\n' ' '))
contas=($(echo "$contas_list" | tr '\n' ' '))

# 3. Loop para execu√ß√£o usando um contador simples
for ((i=0; i<$QTD; i++)); do
    user_id="${ids[$i]}"
    
    # Extrai email e senha da string "email|senha"
    conta_atual="${contas[$i]}"
    email=$(echo "$conta_atual" | cut -d'|' -f1)
    senha=$(echo "$conta_atual" | cut -d'|' -f2)

    # Verifica se temos dados antes de rodar
    if [ -z "$user_id" ] || [ -z "$email" ]; then
        continue
    fi

    echo "------------------------------------------"
    echo "üöÄ [$((i+1))/$QTD] Lan√ßando: $user_id | $email"
    
    # Executa em SEGUNDO PLANO
    python3 shopify_auto.py "$user_id" "$email" "$senha" &

    # Gerenciador de Paralelismo (roda de 2 em 2)
    # Se o resto da divis√£o por 2 for 0, ele espera o par terminar
    if [[ $(( (i+1) % 2 )) -eq 0 ]]; then
        echo "‚è≥ Aguardando conclus√£o do bloco de 2 perfis..."
        wait
    fi
done

# Espera qualquer processo que sobrou (caso a QTD seja √≠mpar)
wait
echo "--- ‚úÖ TODOS OS $QTD PERFIS FINALIZADOS ---"